
#####################################################################
## 	                MCU
#####################################################################
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_400063000951313133353932-if00
restart_method: command

[mcu mmu]
canbus_uuid: 75dee716fb08  

[mcu EBBCan]
canbus_uuid: 4fe9fbb79276   #new one (mounted)
# canbus_uuid: 238e9ac81ed4 #old one

[mcu scanner]
canbus_uuid: aab32f4f6bda

[scanner]
mcu: scanner       
x_offset: 0                      #adjust for your offset
y_offset: 21.1                     #adjust for your offset

backlash_comp: 0.00007
scanner_touch_move_speed: 250
sensor: cartographer
sensor_alt: carto ## allows use of shorter commands. ie CARTO_TOUCH instead of CARTOGRAPHER_TOUCH
mesh_runs: 2
mesh_main_direction: y

[firmware_retraction]
retract_length: 0.4
retract_speed: 45
unretract_speed: 45    

[exclude_object]

[skew_correction] 

[gcode_arcs]

[respond]

# [include PIS.cfg]

[include chopper_tune.cfg]
[include inputshaper.cfg]
[include fans.cfg]
[include macros.cfg] #Includes PRINT_START and PRINT_STOP
[include mainsail.cfg]
[include neopixel.cfg] #LED settings for SB and chamber
[include KAMP_Settings.cfg] #Klipper Auto Mesing and Purging
[include timelapse.cfg]
[include clean_nozzle.cfg] #macro for nozzle clean procedure
[include shell_command.cfg]
#[include mmu/base/*.cfg]
#[include mmu/optional/client_macros.cfg]
#[include mmu/addons/blobifier.cfg]



[led caselight]
white_pin: PA2
hardware_pwm: True
initial_WHITE: 1
cycle_time: 0.01

#####################################################################
#                  ACCELEROMETER
#####################################################################

[adxl345]
cs_pin: EBBCan:gpio1
spi_software_sclk_pin: EBBCan:gpio2
spi_software_mosi_pin: EBBCan:gpio0
spi_software_miso_pin: EBBCan:gpio3
axes_map: z,-y,x

[resonance_tester]
probe_points: 175, 175, 20
accel_chip: adxl345

#[adxl345]
#cs_pin: scanner:PA3
#spi_bus: spi1

#[resonance_tester]
#accel_chip: adxl345
#probe_points: 175, 175, 20

#####################################################################
##	                 Temperature Monitoring
#####################################################################
[temperature_sensor EBB_NTC]
sensor_type: Generic 3950
sensor_pin: EBBCan:gpio28
[temperature_sensor BTT-MCU]        
sensor_type: temperature_mcu
# [temperature_sensor RASP-PI]
# sensor_type: temperature_host
[temperature_sensor chamber]
sensor_type: Generic 3950
sensor_pin: PF4
min_temp: 0
max_temp: 100
[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105
[temperature_sensor electronics_bay]
sensor_type: Generic 3950
sensor_pin: PF5
min_temp: 0
max_temp: 100
[temperature_sensor chamber_top]
sensor_type: Generic 3950
sensor_pin: PF6
min_temp: 0
max_temp: 100
#####################################################################
##                     Model and acceleration
#####################################################################
[printer]
kinematics: corexy           # Printer type：corexy
max_velocity: 350            # Maximum speed (max. 300)
max_accel: 8000              # Maximum acceleration (max. 4000)
max_z_velocity: 15           # Z-axis maximum speed
max_z_accel: 250             # Z-axis maximum acceleration
square_corner_velocity: 5.0  # Square corner speed

#####################################################################
#   B(X) ---------A(Y)
#   |                |
#   |--------E-------|
#   |                |
#   |                |
#   |                |
#####################################################################
##                   X-axis on MOTOR_0(B Motor)
#####################################################################

[stepper_x]
step_pin: PE2 #PF13             # X-axis motor pulse pin setting
dir_pin: !PE3 #!PF12              # X-axis motor direction pin setting
enable_pin: !PD4 #!PF14          # X-axis motor enable pin setting
microsteps: 32             # Motor microsteps Setting
rotation_distance: 39.88 #40      # Active pulley circumference mm (2GT-20T pulley 40, 2GT-16T pulley 32)
full_steps_per_rotation:200   # Number of pulses required for a single motor revolution (1.8 degree motor: 200, 0.9 degree motor: 400)
endstop_pin: EBBCan:gpio24 #PG6           # Limit switch PIN pin setting（X-）
# endstop_pin: tmc2240_stepper_x:virtual_endstop #for sensorless homing
position_min: 0            # X-axis minimum travel - software limit
position_endstop: 350 #350    ## Mechanical reset point coordinates for X-axis (change to 350 for 350 models)
position_max: 350  #350       ## X-axis maximum travel - software limit (change to 350 for 350 models)
homing_speed: 200           # Reset speed maximum 100
homing_retract_dist: 5     # Setback distance after the first trigger of the reset switch
homing_positive_dir: true  # Direction of reset (generally no change required)

[tmc2240 stepper_x]
# diag0_pin: ^!PG14 #for sensorless homing
# driver_SGT: 1 #for sensorless homing
cs_pin: PE1 #PC4
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
driver_TPFD: 0
run_current: 1.2

#####################################################################
##                   Y-axis on MOTOR_1(A Motor)
#####################################################################

[stepper_y]
step_pin: PE6 #PG0              # Y-axis motor pulse pin setting
dir_pin: !PA14 #!PG1               # Y-axis motor direction pin setting
enable_pin: !PE0 #!PF15          # Y-axis motor enable pin setting
microsteps: 32             # Motor microsteps Setting
rotation_distance: 39.88 #40      # Active pulley circumference mm (2GT-20T pulley 40, 2GT-16T pulley 32)
full_steps_per_rotation:200   # Number of pulses required for a single motor revolution (1.8 degree motor: 200, 0.9 degree motor: 400)
endstop_pin: PG9           # Limit switch PIN pin setting（Y-）
# endstop_pin: tmc2240_stepper_y:virtual_endstop #for sensorless homing
position_min: 0            # X-axis minimum travel - software limit
position_endstop: 353  #350      # Mechanical reset point coordinates for Y-axis (change to 350 for 350 models)
position_max: 353  #350          # Y-axis maximum travel - software limit (change to 350 for 350 models)
homing_speed: 200           # Reset speed maximum 100
homing_retract_dist: 5     # Setback distance after the first trigger of the reset switch
homing_positive_dir: true  # Direction of reset (generally no change required)

[tmc2240 stepper_y]
# diag0_pin: ^!PG15 #for sensorless homing
# driver_SGT: 1 #for sensorless homing
cs_pin: PD3 #PD11
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
driver_TPFD: 0
run_current: 1.2

#####################################################################
#   z1 -------------- z2
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#  z0---   display ---z3
#####################################################################
##                  Z0-axis
#####################################################################
##		Z0-axis on MOTOR2_1(left front)
[stepper_z3]
step_pin: PF11    		   # Z-axis motor pulse pin
dir_pin: !PG3               # Z-axis motor direction pin setting
enable_pin: !PG5           # Z-axis motor enable pin setting
rotation_distance: 40      # Active pulley circumference mm (2GT-20T pulley 40, 2GT-16T pulley 32)
gear_ratio: 80:16          # reduction ratio
microsteps: 16             # microsteps

#--------------------------------------------------------------------
[tmc2209 stepper_z3]        # TMC2209
uart_pin: PC6              # drive communications port
interpolate: true          # Whether to enable 256 microstep interpolation
run_current: 0.8           # Motor running current value(mA)
hold_current: 0.8          # holding current(mA)
sense_resistor: 0.110      # Do not change the drive sampling resistor
stealthchop_threshold: 200 # Mute threshold

#--------------------------------------------------------------------#
##		Z1-axis on MOTOR3(left rear)
[stepper_z2]
step_pin: PG4              # Z1-axis motor pulse pin
dir_pin: !PC1              # Z1-axis motor direction pin setting
enable_pin: !PA0           # Z1-axis motor enable pin setting
rotation_distance: 40      # Active pulley circumference mm (2GT-20T pulley 40, 2GT-16T pulley 32)
gear_ratio: 80:16          # reduction ratio
microsteps: 16             # microsteps
#--------------------------------------------------------------------
[tmc2209 stepper_z2]       # TMC2209
uart_pin: PC7              # drive communications port
interpolate: true          # Whether to enable 256 microstep interpolation
run_current: 0.8           # Motor running current value(mA)
hold_current: 0.8          # holding current(mA)
sense_resistor: 0.110      # Do not change the drive sampling resistor
stealthchop_threshold: 200 # Mute threshold

#--------------------------------------------------------------------#
##		Z2-axis on MOTOR4(right-rear)
[stepper_z1]
step_pin: PF9              # Z2-axis motor pulse pin
dir_pin: PF10              # Z2-axis motor direction pin setting
enable_pin: !PG2           # Z2-axis motor enable pin setting
rotation_distance: 40      # Active pulley circumference mm (2GT-20T pulley 40, 2GT-16T pulley 32)
gear_ratio: 80:16          # reduction ratio
microsteps: 16             # microsteps
#--------------------------------------------------------------------
[tmc2209 stepper_z1]       # TMC2209
uart_pin: PF2              # drive communications port
interpolate: true          # Whether to enable 256 microstep interpolation
run_current: 0.8           # Motor running current value(mA)
hold_current: 0.8          # holding current(mA)
sense_resistor: 0.110      # Do not change the drive sampling resistor
stealthchop_threshold: 200 # Mute threshold

#--------------------------------------------------------------------#
##		Z3-axis on MOTOR5(right-front)
[stepper_z]
step_pin: PC13             # Z3-axis motor pulse pin
dir_pin: !PF0              # Z3-axis motor direction pin setting
enable_pin: !PF1           # Z3-axis motor enable pin setting
rotation_distance: 40      # Active pulley circumference mm (2GT-20T pulley 40, 2GT-16T pulley 32)
gear_ratio: 80:16          # reduction ratio
microsteps: 16             # microsteps
endstop_pin: probe:z_virtual_endstop #PG10          # Limit switch interface
position_max: 340   #340       # Maximum Z-axis print height   350mm=340
position_min: -5           # Soft Limit Minimum Stroke
homing_speed: 10           # Reset speed - maximum 20
second_homing_speed: 3     # Secondary reset speed - maximum 10
homing_retract_dist: 0     # Retreat distance
#--------------------------------------------------------------------
[tmc2209 stepper_z]       # TMC2209
uart_pin: PE4              # drive communications port
interpolate: true          # Whether to enable 256 microstep interpolation
run_current: 0.8           # Motor running current value(mA)
hold_current: 0.8          # holding current(mA)
sense_resistor: 0.110      # Do not change the drive sampling resistor
stealthchop_threshold: 200 # Mute threshold

#####################################################################
##                  Extruder motor
#####################################################################

[extruder]
step_pin: EBBCan:gpio18
dir_pin: EBBCan:gpio19
enable_pin: !EBBCan:gpio17
full_steps_per_rotation: 200  # Number of pulses required for a single motor revolution (1.8 degree motor: 200, 0.9 degree motor: 400)
microsteps: 16
gear_ratio: 9:1
#gear_ratio: 50:10
rotation_distance: 47.08
#rotation_distance: 22.44 #22.6012
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan:gpio7
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 300
min_extrude_temp: 0                 # Minimum extrusion temperature
#pressure_advance: 0.025                # Propulsion pressure - try to keep pressure below 1.0
#pressure_advance_smooth_time: 0.040   # Smooth advance time - default value is 0.040
max_extrude_only_distance: 101
max_extrude_cross_section: 5

sensor_type: MAX31865
sensor_pin: EBBCan:gpio9
spi_software_sclk_pin: EBBCan:gpio10
spi_software_mosi_pin: EBBCan:gpio8
spi_software_miso_pin: EBBCan:gpio11
rtd_nominal_r: 100
rtd_reference_r: 430
rtd_num_of_wires: 2

[tmc2209 extruder]
uart_pin: EBBCan:gpio20
run_current: 0.6 #0.550
stealthchop_threshold: 999999

#--------------------------------------------------------------------
[verify_heater extruder]   # Heating Block Temperature Tolerance Configuration
max_error: 120             # maximum error
check_gain_time:120        # tolerance time
hysteresis: 50             # tolerance temperature
heating_gain: 2            # Heating Gain

#####################################################################
##                  Heater_bed
#####################################################################

[heater_bed]
heater_pin: PA3              # (BE0)
sensor_pin: PF3              # sensor interface(TB)
#control: pid                 ##heater_bed Temperature PID Calibration Command:  "PID_CALIBRATE HEATER=heater_bed TARGET=100"
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769
sensor_type: ATC Semitec 104GT-2	 #ATC Semitec 104GT-2
min_temp: 0
max_temp: 120
max_power: 1.0
pwm_cycle_time: 0.02227
	
[verify_heater heater_bed] 
check_gain_time: 90
heating_gain: 1
#####################################################################
# 	                   Bed Grid Calibration
#####################################################################

[bed_mesh]
speed: 300                   # Calibration speed
horizontal_move_z: 5        # Z-axis movement speed
mesh_min: 30,22              # Minimum calibration point coordinates x, y
mesh_max: 320, 300           # Maximum calibration point coordinates x, y
probe_count: 15,15             # Number of sampling points (7X7 is 49 points)
# mesh_pps: 2,2                # Number of supplementary sampling points
algorithm: bicubic           # algorithmic model
# bicubic_tension: 0.2         # Algorithmic interpolation don't move
zero_reference_position: 175,175

#####################################################################
#                          Idle off hot bed
#####################################################################

[idle_timeout]
timeout: 1800                # The hot bed is switched off if the idle time exceeds 30 minutes

####################################################################################
#	                         Gantry levelling 
####################################################################################
[quad_gantry_level]
gantry_corners:
   -60,-10
   410,420
# points:
   # 10,0   # Point 1
   # 10,300  # Point 2
   # 335,300 # Point 3
   # 335,0  # Point 4

points:
	50,25
	50,275
	300,275
	300,25
#--------------------------------------------------------------------
speed: 300
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075
max_adjust: 10

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,       # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,         # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5

[safe_z_home]
home_xy_position: 175,175
speed: 200
z_hop: 10


#--------------------------------------------------------------------
#   Mainsail variables
#--------------------------------------------------------------------
[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos   : False ; use custom park coordinates for x,y [True/False]
variable_custom_park_x    : 0.0   ; custom x position; value must be within your defined min and max of X
variable_custom_park_y    : 0.0   ; custom y position; value must be within your defined min and max of Y
variable_custom_park_dz   : 2.0   ; custom dz value; the value in mm to lift the nozzle when move to park position
variable_retract          : 1.0   ; the value to retract while PAUSE
variable_cancel_retract   : 7.0   ; the value to retract while CANCEL_PRINT
variable_speed_retract    : 35.0  ; retract speed in mm/s
variable_unretract        : 1.0   ; the value to unretract while RESUME
variable_speed_unretract  : 35.0  ; unretract speed in mm/s
variable_speed_hop        : 15.0  ; z move speed in mm/s
variable_speed_move       : 100.0 ; move speed in mm/s
variable_park_at_cancel   : False ; allow to move the toolhead to park while execute CANCEL_PRINT [True/False]
variable_park_at_cancel_x : None  ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
variable_park_at_cancel_y : None  ; different park position during CANCEL_PRINT [None/Position as Float]; park_at_cancel must be True
## !!! Caution [firmware_retraction] must be defined in the printer.cfg if you set use_fw_retract: True !!!
variable_use_fw_retract   : False ; use fw_retraction instead of the manual version [True/False]
variable_idle_timeout     : 0     ; time in sec until idle_timeout kicks in. Value 0 means that no value will be set or restored
#variable_runout_sensor    : "switch_sensor"    ; If a sensor is defined, it will be used to cancel the execution of RESUME in case no filament is detected.
##                                   Specify the config name of the runout sensor e.g "filament_switch_sensor runout". Hint use the same as in your printer.cfg
## !!! Custom macros, please use with care and review the section of the corresponding macro.
## These macros are for simple operations like setting a status LED. Please make sure your macro does not interfere with the basic macro functions.
## Only  single line commands are supported, please create a macro if you need more than one command.
#variable_user_pause_macro : ""    ; Everything inside the "" will be executed after the klipper base pause (PAUSE_BASE) function
#variable_user_resume_macro: ""    ; Everything inside the "" will be executed before the klipper base resume (RESUME_BASE) function
#variable_user_cancel_macro: ""    ; Everything inside the "" will be executed before the klipper base cancel (CANCEL_PRINT_BASE) function
gcode:

[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
# number_of_results_to_keep: 3
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
# keep_raw_csv: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
# timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 63.447
#*# pid_ki = 3.845
#*# pid_kd = 261.719
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.358
#*# pid_ki = 1.780
#*# pid_kd = 90.338
#*#
#*# [skew_correction CaliFlower]
#*# xy_skew = -0.0004997756825141388
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [skew_correction my_skew_profile]
#*# xy_skew = -0.0006848229295855215
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 3250
#*# scanner_touch_speed = 3
#*#
#*# [scanner model default]
#*# model_coef = 1.456613757861677,
#*# 	1.778142092881101,
#*# 	0.7384639909879536,
#*# 	0.5219059521190788,
#*# 	0.525599806051943,
#*# 	-0.15759977015818494,
#*# 	-0.5065007087147642,
#*# 	0.31012703161239746,
#*# 	0.4359327478147003,
#*# 	-0.001200171556988553
#*# model_domain = 3.1050812117073765e-07,3.2972788934375783e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 25.425597
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.129559, 0.110125, 0.094478, 0.081793, 0.070527, 0.059614, 0.047561, 0.043289, 0.044321, 0.052892, 0.060493, 0.074407, 0.094653, 0.116533, 0.142049
#*# 	  0.106738, 0.086537, 0.074094, 0.056188, 0.047140, 0.039164, 0.031063, 0.021559, 0.030737, 0.033590, 0.041780, 0.056176, 0.076931, 0.100864, 0.124640
#*# 	  0.100773, 0.081531, 0.069091, 0.052814, 0.045671, 0.035142, 0.030013, 0.021928, 0.028286, 0.034949, 0.045511, 0.059649, 0.078564, 0.101121, 0.120645
#*# 	  0.093144, 0.073892, 0.061610, 0.046663, 0.038675, 0.026253, 0.022179, 0.015390, 0.022761, 0.032741, 0.036744, 0.052517, 0.071509, 0.091481, 0.108917
#*# 	  0.086354, 0.064485, 0.054970, 0.042587, 0.033510, 0.023917, 0.016793, 0.010888, 0.015574, 0.026114, 0.034058, 0.047609, 0.065279, 0.082531, 0.098028
#*# 	  0.073146, 0.054855, 0.043835, 0.029745, 0.020697, 0.011223, 0.003931, 0.000048, 0.005882, 0.016165, 0.023163, 0.036947, 0.055883, 0.074024, 0.089882
#*# 	  0.074121, 0.055514, 0.041713, 0.024625, 0.019899, 0.011339, 0.003392, 0.000848, 0.004595, 0.015155, 0.023416, 0.036353, 0.056913, 0.075009, 0.091230
#*# 	  0.070194, 0.050100, 0.036604, 0.020912, 0.015585, 0.010439, 0.002558, 0.000868, 0.006639, 0.015644, 0.026804, 0.040196, 0.060179, 0.078942, 0.093157
#*# 	  0.066316, 0.049824, 0.034795, 0.020544, 0.014063, 0.011266, 0.003536, 0.005924, 0.009816, 0.022051, 0.031233, 0.045174, 0.064202, 0.085668, 0.103191
#*# 	  0.055066, 0.039929, 0.027136, 0.014353, 0.008855, 0.003186, -0.001774, 0.000826, 0.007124, 0.017490, 0.026847, 0.039587, 0.061058, 0.081943, 0.102361
#*# 	  0.064153, 0.045498, 0.037082, 0.023331, 0.017999, 0.010527, 0.004149, 0.004830, 0.012640, 0.020848, 0.031924, 0.045189, 0.067618, 0.093548, 0.107824
#*# 	  0.072980, 0.056061, 0.047204, 0.034078, 0.028325, 0.021429, 0.013204, 0.012891, 0.020172, 0.029672, 0.037514, 0.048196, 0.069505, 0.094313, 0.112305
#*# 	  0.089261, 0.072918, 0.062191, 0.051039, 0.044692, 0.037483, 0.028920, 0.031081, 0.033724, 0.046567, 0.049996, 0.058667, 0.082517, 0.094159, 0.116773
#*# 	  0.099801, 0.081625, 0.072852, 0.061761, 0.055624, 0.046934, 0.042264, 0.043118, 0.050076, 0.059952, 0.065969, 0.077167, 0.092906, 0.104830, 0.122837
#*# 	  0.100541, 0.087083, 0.077095, 0.065986, 0.061523, 0.054583, 0.050338, 0.056429, 0.059015, 0.069419, 0.075601, 0.087524, 0.100428, 0.116991, 0.134008
#*# x_count = 15
#*# y_count = 15
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 320.0
#*# min_y = 22.0
#*# max_y = 300.0
